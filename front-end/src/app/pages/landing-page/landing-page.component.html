<div class="flex" *transloco="let t">
  <app-aside-nav-bar></app-aside-nav-bar>

  <div class="h-screen w-screen flex items-center justify-center bg-gray-200 overflow-hidden">
    <main class="h-full w-full flex flex-col p-4 shadow-lg rounded-lg">
      <div class="!rounded-lg !shadow-md !p-4 bg-white mt-4">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center">
            <img src="time2wish-logo.png" [alt]="t('toolbar.logo_alt')" class="h-12 md:h-16 ml-2 md:ml-7" />
          </div>

          <div class="group flex items-center w-full max-w-2xl rounded-full bg-gray-200 transition-all duration-300 focus-within:bg-white focus-within:shadow-md border border-gray-300">
            <button mat-icon-button class="!w-10 !h-10 flex items-center justify-center m-2">
              <mat-icon [matTooltip]="t('search.tooltip')">search</mat-icon>
            </button>

            <input
              matInput
              [placeholder]="t('search.placeholder')"
              class="flex-1 bg-transparent border-none focus:outline-none py-2"
              [(ngModel)]="searchQuery"
              (ngModelChange)="updateSearchQuery($event); updateSuggestions($event)"
              [matAutocomplete]="auto"
            />

            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectSuggestion($event.option.value)">
              @for (suggestion of suggestions; track suggestion) {
                <mat-option [value]="suggestion">{{ suggestion }}</mat-option>
              }
            </mat-autocomplete>

            @if (searchQuery) {
              <button mat-icon-button class="!w-10 !h-10 flex items-center justify-center m-2" (click)="searchQuery = ''; updateSearchQuery('')">
                <mat-icon>close</mat-icon>
              </button>
            } @else {
              <button mat-icon-button [matMenuTriggerFor]="filterMenu" class="!w-10 !h-10 flex items-center justify-center m-2">
                <mat-icon class="text-gray-500" [matTooltip]="t('search.filter_tooltip')">tune</mat-icon>
              </button>
            }

            <mat-menu #filterMenu="matMenu">
              <button mat-menu-item disabled>
                <span class="font-medium">{{ t('search.filter_by') }}</span>
              </button>
              <mat-divider></mat-divider>
              @for (col of availableColumns; track col.value) {
                <button mat-menu-item (click)="updateAdvancedFilter(col.value)" [class.bg-blue-50]="advancedFilter.column === col.value">
                  <mat-icon>{{ col.icon }}</mat-icon>
                  <span>{{ t('search.columns.' + col.value) }}</span>
                  @if (advancedFilter.column === col.value) {
                    <mat-icon class="ml-auto text-blue-500">check</mat-icon>
                  }
                </button>
              }
            </mat-menu>
          </div>

          <div class="flex items-center gap-1 md:gap-4">
            <button mat-icon-button (click)="toggleTheme()" class="!w-10 !h-10 flex items-center justify-center" [matTooltip]="t('toolbar.theme')">
              <mat-icon>{{ isDarkTheme ? "light_mode" : "dark_mode" }}</mat-icon>
            </button>

            <button
              mat-icon-button
              [matBadge]="notificationService.unreadCount$ | async"
              [matBadgeHidden]="(notificationService.unreadCount$ | async) === 0"
              matBadgeColor="warn"
              matBadgeSize="large"
              class="!w-10 !h-10 !flex !items-center !justify-center relative"
              (click)="onNotification()"
              [matTooltip]="t('toolbar.notifications')"
            >
              <mat-icon>notifications</mat-icon>
            </button>

            <button mat-icon-button (click)="toggleView(viewMode === 'table' ? 'cards' : 'table')" [matTooltip]="viewMode === 'table' ? t('toolbar.view_cards') : t('toolbar.view_table')">
              <mat-icon>{{ viewMode === 'table' ? 'view_module' : 'table_chart' }}</mat-icon>
            </button>

            <app-set-language></app-set-language>

            <button mat-icon-button class="!w-10 !h-10 flex items-center justify-center" (click)="onInformation()" [matTooltip]="t('toolbar.help')">
              <mat-icon>help_outline</mat-icon>
            </button>

            @let currentUser = authService.currentUser$ | async;
            <span *ngIf="currentUser" [matBadge]="currentUser?.status" [matBadgeHidden]="!currentUser?.status" [ngClass]="getBadgeClass(currentUser.status)" matBadgeSize="large" matBadgeOverlap="true">
              <button mat-icon-button [matMenuTriggerFor]="profileMenu" class="flex items-center justify-center" [matTooltip]="t('toolbar.profile')">
                <img *ngIf="currentUser?.profilePicture" [src]="currentUser?.profilePicture" class="rounded-full" />
                <mat-icon *ngIf="!currentUser?.profilePicture">account_circle</mat-icon>
              </button>
            </span>
            <mat-menu #profileMenu="matMenu">
              <button mat-menu-item (click)="onProfil()">
                <mat-icon>person</mat-icon>
                <span>{{ t('toolbar.profile') }}</span>
              </button>
              <button mat-menu-item [routerLink]="['/login']">
                <mat-icon>logout</mat-icon>
                <span>{{ t('toolbar.logout') }}</span>
              </button>
            </mat-menu>
          </div>
        </div>

        @if (advancedFilter.column !== 'all') {
          <div class="text-sm text-gray-500 mt-1 ml-60 flex items-center">
            <mat-icon class="!text-sm mr-1">filter_alt</mat-icon>
            {{ t('search.filtering_in') }}
            <span class="font-medium ml-1">
              {{ t('search.columns.' + advancedFilter.column) }}
            </span>
          </div>
        }
      </div>

      <div class="bg-white flex shadow-md justify-center gap-5 rounded-lg p-4 mt-4">
        <mat-button-toggle-group [value]="activeButton$ | async" (change)="setActiveButton($event.value)" class="!border-none rounded-full bg-gray-200 p-1">
          <mat-button-toggle value="coming" class="!rounded-full !font-medium !px-4 !py-2 !border-none !transition-all" [class.!bg-white]="(activeButton$ | async) === 'coming'">
            {{ t('anniversary.coming') }}
          </mat-button-toggle>
          <mat-button-toggle value="passed" class="!rounded-full !font-medium !px-4 !py-2 !border-none !transition-all" [class.!bg-white]="(activeButton$ | async) === 'passed'">
            {{ t('anniversary.passed') }}
          </mat-button-toggle>
        </mat-button-toggle-group>

        <div class="flex items-center gap-2">
          <mat-icon class="text-gray-500">calendar_today</mat-icon>
          <span class="font-medium text-gray-800">{{ currentDate | date : "dd.MM.yyyy" }}</span>
        </div>
        <div class="flex items-center gap-2">
          <mat-icon class="text-gray-500">schedule</mat-icon>
          <span class="font-medium text-gray-800">{{ currentDate | date : "HH:mm" }}</span>
        </div>
      </div>

      <div class="mt-4 flex-1 overflow-hidden bg-white rounded-lg shadow-lg p-4 mb-4">
        @if (loading) {
          <div class="bg-white flex flex-col flex-1 items-center justify-center h-full">
            <mat-spinner diameter="50" color="primary"></mat-spinner>
            <p class="text-gray-600 text-sm mt-2">{{ t('anniversary.loading') }}</p>
          </div>
        } @else {
          <div class="flex flex-col h-full">
            @if (viewMode === 'table') {
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 p-4 border-b border-gray-200 shrink-0">
                <div class="flex justify-center flex-wrap gap-2">
                  <button mat-button class="flex items-center gap-1">
                    <mat-icon>file_upload</mat-icon> {{ t('actions.import') }}
                  </button>
                  <button mat-button class="flex items-center gap-1">
                    <mat-icon>file_download</mat-icon> {{ t('actions.export') }}
                  </button>
                </div>
              </div>
            }

            <div class="flex-1 overflow-y-auto">
              @if (hasBirthdays$ | async) {
                @if (viewMode === 'table') {
                  <app-birthday-table class="flex-1" [birthdays]="dataSource.data" (edit)="editBirthday()" (delete)="deleteBirthday($event)" (refresh)="handleRefresh()"></app-birthday-table>
                } @else {
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    @for (item of dataSource.data; track item.id) {
                      <app-birthday-card [item]="item" (edit)="editBirthday()" (delete)="deleteBirthday(item.id)" (details)="openBirthdayDetails(item)"></app-birthday-card>
                    }
                  </div>
                }
              } @else {
                <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                  <mat-icon class="text-4xl w-12 h-12 mb-2">event_busy</mat-icon>
                  <p class="text-lg">
                    {{ (activeButton$ | async) === "coming" ? t('anniversary.empty_coming') : t('anniversary.empty_passed') }}
                  </p>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <app-footer></app-footer>
    </main>
  </div>
</div>